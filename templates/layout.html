<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Dashboard{% endblock %} - Food Pulse</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <style>
        /* Additional styles for dashboards */
        .dashboard-container { max-width: 1400px; margin: 100px auto 40px; padding: 0 40px; }
        .dashboard-header { margin-bottom: 40px; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 20px; }
        .dashboard-header h1 { font-size: 2.5rem; }
        .dashboard-header p { font-size: 1.1rem; opacity: 0.8; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.2); }
        th { background: rgba(255,255,255,0.1); }
        .form-section { background: rgba(0,0,0,0.2); padding: 30px; border-radius: 15px; margin-bottom: 40px; }
        .btn-secondary { background: #4a5568; color: white; padding: 10px 20px; border-radius: 8px; text-decoration: none; border: none; cursor: pointer; }

        /* --- Chatbot Styles (Moved Here) --- */
        .chat-widget { position: fixed; bottom: 25px; right: 25px; z-index: 1001; }
        .chat-bubble { width: 60px; height: 60px; background-color: #ffffff; color: #1a4d2e; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3); transition: transform 0.2s ease; }
        .chat-bubble:hover { transform: scale(1.1); }
        .chat-window { position: absolute; bottom: 80px; right: 0; width: 350px; height: 500px; background: rgba(15, 58, 31, 0.9); border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 15px; backdrop-filter: blur(10px); box-shadow: 0 10px 40px rgba(0,0,0,0.4); display: flex; flex-direction: column; overflow: hidden; transform: scale(0); transform-origin: bottom right; transition: transform 0.3s ease-in-out; }
        .chat-widget.open .chat-window { transform: scale(1); }
        .chat-header { padding: 15px; background: rgba(0,0,0,0.2); color: white; display: flex; justify-content: space-between; align-items: center; }
        .chat-header h4 { margin: 0; font-weight: 600; }
        .chat-close { background: none; border: none; color: white; font-size: 24px; cursor: pointer; opacity: 0.7; }
        .chat-close:hover { opacity: 1; }
        .chat-log { flex-grow: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
        .chat-message { max-width: 80%; padding: 10px 15px; border-radius: 18px; line-height: 1.5; }
        .chat-message.user { background-color: white; color: #1a4d2e; align-self: flex-end; border-bottom-right-radius: 5px; }
        .chat-message.bot { background-color: rgba(255, 255, 255, 0.15); color: white; align-self: flex-start; border-bottom-left-radius: 5px; }
        .chat-input-area { display: flex; padding: 15px; border-top: 1px solid rgba(255, 255, 255, 0.2); }
        #chat-input { flex-grow: 1; border: none; background: rgba(0,0,0,0.2); color: white; padding: 10px; border-radius: 20px; }
        #chat-input:focus { outline: none; }
        #chat-send-btn { background: white; color: #1a4d2e; border: none; border-radius: 50%; width: 40px; height: 40px; margin-left: 10px; cursor: pointer; font-size: 18px; }
    </style>
</head>
<body>
    <div class="background-overlay"></div>

    <nav class="navbar">
        <div class="nav-container">
            <a href="{{ url_for('dashboard') }}" class="nav-logo">Food Pulse</a>
            <div class="nav-menu">
                <a href="{{ url_for('dashboard') }}" class="nav-link">Dashboard</a>
                <a href="{{ url_for('profile') }}" class="nav-link">Profile</a>
                <a href="{{ url_for('logout') }}" class="nav-link">Logout</a>
            </div>
        </div>
    </nav>

    <div class="dashboard-container">
        {% block content %}{% endblock %}
    </div>

    <div class="chat-widget">
        <div class="chat-bubble">ðŸ’¬</div>
        <div class="chat-window">
            <div class="chat-header">
                <h4>PulseBot Assistant</h4>
                <button class="chat-close">&times;</button>
            </div>
            <div class="chat-log" id="chat-log">
                <div class="chat-message bot">Hello! I'm PulseBot. How can I help you understand Food Pulse today?</div>
            </div>
            <div class="chat-input-area">
                <input type="text" id="chat-input" placeholder="Ask a question...">
                <button id="chat-send-btn">âž¤</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const chatWidget = document.querySelector('.chat-widget');
            const chatBubble = document.querySelector('.chat-bubble');
            const chatCloseBtn = document.querySelector('.chat-close');
            const chatLog = document.getElementById('chat-log');
            const chatInput = document.getElementById('chat-input');
            const chatSendBtn = document.getElementById('chat-send-btn');

            // Toggle chat window visibility
            chatBubble.addEventListener('click', () => chatWidget.classList.toggle('open'));
            chatCloseBtn.addEventListener('click', () => chatWidget.classList.remove('open'));

            // Function to add a message to the chat log
            function addMessage(sender, text) {
                const messageElem = document.createElement('div');
                messageElem.classList.add('chat-message', sender);
                messageElem.textContent = text;
                chatLog.appendChild(messageElem);
                chatLog.scrollTop = chatLog.scrollHeight; // Auto-scroll
            }

            // Function to handle sending a message
            async function sendMessage() {
                const messageText = chatInput.value.trim();
                if (messageText === '') return;

                // Display user's message
                addMessage('user', messageText);
                chatInput.value = '';

                // Show a "typing" indicator
                const typingIndicator = document.createElement('div');
                typingIndicator.classList.add('chat-message', 'bot');
                typingIndicator.textContent = 'â— â— â—';
                chatLog.appendChild(typingIndicator);
                chatLog.scrollTop = chatLog.scrollHeight;

                try {
                    // Send message to the Flask backend
                    const response = await fetch('/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ message: messageText }),
                    });

                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }

                    const data = await response.json();
                    
                    // Remove "typing" indicator and display bot's reply
                    chatLog.removeChild(typingIndicator);
                    addMessage('bot', data.reply);

                } catch (error) {
                    // Handle errors
                    console.error('Chat error:', error);
                    chatLog.removeChild(typingIndicator);
                    addMessage('bot', 'Sorry, I am having trouble connecting. Please try again.');
                }
            }

            // Event listeners for sending a message
            chatSendBtn.addEventListener('click', sendMessage);
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
        });
    </script>
</body>
</html>